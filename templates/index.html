<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dockpeek</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/svg+xml" href="/static/logo.svg" />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f6f8fa;
      color: #24292e;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .container {
      background-color: #ffffff;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .logo-title {
      color: #e1e4e8;
    }
    body.dark-mode .logo-title {
      color: #2a2f37;
    }
    .github {
      color: #acb1b9;
    }
    body.dark-mode .github {
      color: #6a737d;
    }

    .status-none {
      color: #b8bcc3;
    }

    body.dark-mode .status-none {
      color: #474c55;
    }

     .data-content-name {
      color: #30363d;
    }
    body.dark-mode .data-content-name {
      color: #c9d1d9;
    }

    .text-gray-800 {
      color: #949da7;
    }

    .text-gray-600 {
      color: #586069;
    }

    .text-gray-700 {
      color: #24292e;
    }

    .text-gray-900 {
      color: #30363d;
    }

    .bg-gray-100 {
      background-color: #f3f4f6;
    }

    .border-gray-200 {
      border-color: #e1e4e8;
    }

    .hover\:bg-gray-50:hover {
      background-color: #fafafa !important;
    }

    .text-muted,
    .text-secondary {
      color: #6a737d;
    }

    .badge {
      background-color: #e1e4e8;
      color: #2188ff;
      border-radius: 0.375rem;
      margin: 0.15rem 0.5rem;
      padding: 0.15rem 0.5rem;
      font-weight: 600;
      display: inline-block;
    }

    body.dark-mode .badge {
      background-color: #21262d;
      color: #2188ff;
    }

    .sortable-header {
      cursor: pointer;
      position: relative;
      padding-right: 20px;
    }

    .sortable-header::after {
      content: "";
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-bottom: 5px solid #24292e;
    }

    .sortable-header.desc::after {
      border-top: 5px solid #24292e;
      border-bottom: none;
    }

    input[type="text"] {
      background-color: #f6f8fa;
      border: 1px solid #e1e4e8;
      border-radius: 0.5rem;
      color: #24292e;
      padding: 0.75rem;
      width: 100%;
    }

    #search-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px #2188ff;
      border-color: transparent;
    }

    #search-input::placeholder {
      color: #6a737d;
    }

    #theme-switcher,
    #export-json-button {
      background-color: #e1e4e8;
      color: #626c78;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      transition: background-color 0.15s ease-in-out;
    }

    #theme-switcher:hover,
    #export-json-button:hover {
      background-color: #d1d5da;
    }

    #theme-switcher:focus,
    #export-json-button:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(108, 117, 125, 0.75);
    }

    .text-red-500 {
      color: #cb2431;
    }

    .status-running {
      color: #28a745;
      font-weight: 600;
    }

    .status-exited {
      color: #dc3545;
      font-weight: 600;
    }

    code {
      background-color: #f3f4f6;
      color: #24292e;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
    }

    /* Dark Mode Styles */
    body.dark-mode {
      background-color: #0d1117;
      color: #c9d1d9;
    }

    body.dark-mode .container {
      background-color: #161b22;
    }

    body.dark-mode .text-gray-800 {
      color: #24292e;
    }

    body.dark-mode .text-gray-600 {
      color: #8b949e;
    }

    body.dark-mode .text-gray-700 {
      color: #c9d1d9;
    }

    body.dark-mode .text-gray-900 {
      color: #c9d1d9;
    }

    body.dark-mode .bg-gray-100 {
      background-color: #21262d;
    }

    body.dark-mode .border-gray-200 {
      border-color: #30363d;
    }

    body.dark-mode table {
      background-color: #161b22;
      border-color: #30363d;
    }

    body.dark-mode .hover\:bg-gray-50:hover {
      background-color: #21262d !important;
    }

    body.dark-mode .text-muted,
    body.dark-mode .text-secondary {
      color: #8b949e;
    }

    body.dark-mode .badge.text-bg-dark {
      color: #2188ff;
    }

    body.dark-mode .sortable-header::after {
      border-bottom-color: #c9d1d9;
      border-top-color: #c9d1d9;
    }

    body.dark-mode input[type="text"] {
      background-color: #0d1117;
      border-color: #30363d;
      color: #c9d1d9;
    }

    body.dark-mode #search-input::placeholder {
      color: #8b949e;
    }

    body.dark-mode #theme-switcher,
    body.dark-mode #export-json-button {
      background-color: #21262d;
      color: #97a1ab;
    }

    body.dark-mode #theme-switcher:hover,
    body.dark-mode #export-json-button:hover {
      background-color: #30363d;
    }

    body.dark-mode .text-red-500 {
      color: #f85149;
    }

    body.dark-mode code {
      background-color: #21262d;
      color: #c9d1d9;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .flex.justify-between.items-center.mb-6 {
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .controls-container {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
        margin-top: 1rem;
      }

      .controls-container>* {
        margin-bottom: 0.5rem;
        width: 100%;
      }

      th[data-sort-column="image"],
      th[data-sort-column="status"],
      td.table-cell-image,
      td.table-cell-status {
        display: none;
      }

      .py-3.px-4 {
        padding: 0.5rem 0.75rem;
      }

      .min-w-full {
        min-width: unset;
      }

      .overflow-x-auto {
        overflow-x: hidden;
      }
    }

    /* Confirmation Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background-color: #ffffff;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    body.dark-mode .modal-content {
      background-color: #161b22;
      border: 1px solid #30363d;
    }

    body.dark-mode #modal-cancel-button {
      background-color: #21262d;
      /* Darker background for dark mode */
      color: #c9d1d9;
      /* Lighter text for dark mode */
    }

    body.dark-mode #modal-cancel-button:hover {
      background-color: #30363d;
      /* Even darker on hover in dark mode */
    }

    /* Loading Spinner */
    .loader {
      border: 4px solid #f3f3f3;
      /* Light grey */
      border-top: 4px solid #3498db;
      /* Blue */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    body.dark-mode .loader {
      border-color: #21262d;
      border-top-color: #2188ff;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="p-6">
  <div class="container mx-auto bg-white rounded-lg shadow-xl p-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="logo-title text-3xl font-bold">dockpeek</h1>
      <div class="flex space-x-4 items-center text-sm controls-container">
        <a href="https://github.com/dockpeek/dockpeek" target="_blank"
          class="github no-underline">
          GitHub
        </a>
        <button id="theme-switcher" title="Switch Theme"
          class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75">
          <span id="theme-icon"> </span>
        </button>
        <button id="export-json-button"
          class="flex items-center space-x-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v6m0 0l-3-3m3 3l3-3m-6-9h6" />
          </svg>
          <span>Export to JSON</span>
        </button>
        <a href="/logout" id="logout-button"
          class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 text-center">
          Logout
        </a>
      </div>
    </div>

    <div class="mb-6">
      <input type="text" id="search-input" placeholder="Search by name, image, or port..."
        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
    </div>

    <div id="container-table-wrapper" class="overflow-x-auto rounded-lg overflow-hidden">
      <table class="min-w-full bg-white border border-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 border-b border-gray-200 sortable-header"
              data-sort-column="name">
              Container
            </th>
            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 border-b border-gray-200 sortable-header"
              data-sort-column="ports">
              Ports
            </th>
            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 border-b border-gray-200 sortable-header"
              data-sort-column="image">
              Image
            </th>
            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 border-b border-gray-200 sortable-header"
              data-sort-column="status">
              Status
            </th>
          </tr>
        </thead>
        <tbody id="container-rows">
        </tbody>
      </table>
    </div>

  </div>

  <template id="container-row-template">
    <tr class="hover:bg-gray-50 transition duration-150 ease-in-out">
      <td class="data-content-name py-3 px-4 border-b border-gray-200 font-bold" data-content="name">
      </td>
      <td class="py-3 px-4 border-b border-gray-200" data-content="ports">
      </td>
      <td class="py-3 px-4 border-b border-gray-200 table-cell-image">
        <code class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-sm" data-content="image"></code>
      </td>
      <td class="py-3 px-4 border-b border-gray-200 table-cell-status" data-content="status">
      </td>
    </tr>
  </template>

  <div id="confirmation-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 id="modal-title" class="text-xl font-bold mb-4 text-gray-900">Confirmation</h2>
      <p id="modal-message" class="text-gray-600 mb-6">Are you sure?</p>
      <div class="flex justify-center space-x-4">
        <button id="modal-cancel-button"
          class="px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">Cancel</button>
        <button id="modal-confirm-button"
          class="px-6 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600">Confirm</button>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // --- STATE MANAGEMENT ---
      let allContainersData = []; // Raw data from the server
      let filteredAndSortedContainers = []; // Data after filtering and sorting
      let currentSortColumn = "name";
      let currentSortDirection = "asc";

      // --- DOM ELEMENT SELECTORS ---
      const searchInput = document.getElementById("search-input");
      const containerRowsBody = document.getElementById("container-rows");
      const body = document.body;
      const rowTemplate = document.getElementById("container-row-template");

      /**
       * Shows a loading indicator in the table body.
       */
      function showLoadingIndicator() {
        containerRowsBody.innerHTML = `<tr><td colspan="4"><div class="loader"></div></td></tr>`;
      }

      /**
       * Displays an error message in the table body.
       * @param {string} message - The error message to display.
       */
      function displayError(message) {
        containerRowsBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-red-500">${message}</td></tr>`;
      }

      /**
       * Renders the container table using the HTML template.
       */
      function renderTable() {
        containerRowsBody.innerHTML = ""; // Clear previous content

        const pageItems = filteredAndSortedContainers;

        if (pageItems.length === 0) {
          if (searchInput.value) {
            containerRowsBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500">No containers found matching your criteria.</td></tr>`;
          } else {
            containerRowsBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500">No containers to display.</td></tr>`;
          }
          return;
        }

        const fragment = document.createDocumentFragment();
        for (const c of pageItems) {
          const clone = rowTemplate.content.cloneNode(true);

          clone.querySelector('[data-content="name"]').textContent = c.name;
          clone.querySelector('[data-content="image"]').textContent = c.image;

          const statusCell = clone.querySelector('[data-content="status"]');
          statusCell.textContent = c.status;
          statusCell.className = `py-3 px-4 border-b border-gray-200 table-cell-status ${c.status === "running" ? "status-running" : "status-exited"}`;

          const portsCell = clone.querySelector('[data-content="ports"]');
          if (c.ports.length > 0) {
            portsCell.innerHTML = c.ports.map(p =>
              `<a href="${p.link}" target="_blank" class="badge text-bg-dark me-1 rounded">${p.host_port}</a> <small class="text-secondary">→ ${p.container_port}</small>`
            ).join('<br>');
          } else {
            portsCell.innerHTML = `<span class="status-none" style="padding-left: 15px;">none</span>`;
          }
          fragment.appendChild(clone);
        }
        containerRowsBody.appendChild(fragment);
      }

      /**
       * Sorts and filters the container list, then triggers a re-render.
       */
      function updateDisplay() {
        const searchTerm = searchInput.value.toLowerCase().trim();

        const filtered = allContainersData.filter(c =>
          c.name.toLowerCase().includes(searchTerm) ||
          c.image.toLowerCase().includes(searchTerm) ||
          c.ports.some(p => p.host_port.includes(searchTerm) || p.container_port.includes(searchTerm))
        );

        filtered.sort((a, b) => {
          let valA = a[currentSortColumn];
          let valB = b[currentSortColumn];

          if (currentSortColumn === "status") {
            const statusOrder = { running: 1, exited: 2 };
            valA = statusOrder[valA] || 0;
            valB = statusOrder[valB] || 0;
          } else if (currentSortColumn === "ports") {
            const getFirstPort = (container) => container.ports.length > 0 ? parseInt(container.ports[0].host_port, 10) : 0;
            valA = getFirstPort(a);
            valB = getFirstPort(b);
          } else if (typeof valA === "string" && typeof valB === "string") {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
          }

          if (valA < valB) return currentSortDirection === "asc" ? -1 : 1;
          if (valA > valB) return currentSortDirection === "asc" ? 1 : -1;
          return 0;
        });

        filteredAndSortedContainers = filtered;
        renderTable();
      }

      /**
       * Fetches container data from the backend with improved error handling.
       */
      async function fetchContainerData() {
        showLoadingIndicator();
        try {
          const response = await fetch("/data");
          if (!response.ok) {
            let errorMsg;
            switch (response.status) {
              case 401:
              case 403:
                errorMsg = `Authorization Error (${response.status}): You might need to log in again.`;
                break;
              case 500:
                errorMsg = `Server Error (${response.status}): The server encountered an issue. Please try again later.`;
                break;
              default:
                errorMsg = `HTTP Error: ${response.status} ${response.statusText}`;
            }
            throw new Error(errorMsg);
          }
          allContainersData = await response.json();
          updateDisplay();
        } catch (error) {
          console.error("Error fetching container data:", error);
          const finalMessage = error.message.includes('Failed to fetch')
            ? `Network Error: Could not connect to the backend. Is it running?`
            : error.message;
          displayError(finalMessage);
        }
      }

      // --- THEME SWITCHER LOGIC ---
      function applyTheme(theme) {
        const themeIcon = document.getElementById("theme-icon");
        if (theme === "dark") {
          body.classList.add("dark-mode");
          themeIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 0111.21 3 7 7 0 0012 21c4.97 0 9-4.03 9-9 0-.07 0-.14-.01-.21z" /></svg>`;
        } else {
          body.classList.remove("dark-mode");
          themeIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="4" /><line x1="12" y1="2" x2="12" y2="4" /><line x1="12" y1="20" x2="12" y2="22" /><line x1="5" y1="5" x2="6.5" y2="6.5" /><line x1="17.5" y1="17.5" x2="19" y2="19" /><line x1="2" y1="12" x2="4" y2="12" /><line x1="20" y1="12" x2="22" y2="12" /><line x1="5" y1="19" x2="6.5" y2="17.5" /><line x1="17.5" y1="6.5" x2="19" y2="5" /></svg>`;
        }
        localStorage.setItem("theme", theme);
      }

      // --- MODAL LOGIC ---
      const modal = document.getElementById("confirmation-modal");
      const modalConfirmBtn = document.getElementById("modal-confirm-button");
      const modalCancelBtn = document.getElementById("modal-cancel-button");

      /**
       * Displays a confirmation modal and returns a Promise that resolves or rejects based on user action.
       * @param {string} title - The title for the modal.
       * @param {string} message - The confirmation message.
       * @param {string} confirmText - The text for the confirm button.
       */
      function showConfirmationModal(title, message, confirmText = 'Confirm') {
        return new Promise((resolve, reject) => {
          document.getElementById('modal-title').textContent = title;
          document.getElementById('modal-message').textContent = message;
          modalConfirmBtn.textContent = confirmText;
          modal.classList.remove('hidden');

          const confirmHandler = () => {
            modal.classList.add('hidden');
            cleanup();
            resolve();
          };

          const cancelHandler = () => {
            modal.classList.add('hidden');
            cleanup();
            reject();
          };

          const backdropClickHandler = (e) => {
            if (e.target === modal) {
              cancelHandler();
            }
          };

          const cleanup = () => {
            modalConfirmBtn.removeEventListener('click', confirmHandler);
            modalCancelBtn.removeEventListener('click', cancelHandler);
            modal.removeEventListener('click', backdropClickHandler);
          };

          modalConfirmBtn.addEventListener('click', confirmHandler, { once: true });
          modalCancelBtn.addEventListener('click', cancelHandler, { once: true });
          modal.addEventListener('click', backdropClickHandler, { once: true });
        });
      }



      // --- INITIALIZATION & EVENT LISTENERS ---

      // Initial data fetch
      fetchContainerData();

      // Apply saved theme
      applyTheme(localStorage.getItem("theme") || "dark");

      // Theme switcher
      document.getElementById("theme-switcher").addEventListener("click", () => {
        applyTheme(body.classList.contains("dark-mode") ? "light" : "dark");
      });

      // Search input
      searchInput.addEventListener("input", updateDisplay);

      // Sorting headers
      document.querySelectorAll(".sortable-header").forEach((header) => {
        header.addEventListener("click", () => {
          const column = header.dataset.sortColumn;
          if (column === currentSortColumn) {
            currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
          } else {
            currentSortColumn = column;
            currentSortDirection = "asc";
          }
          // Update header classes for sort direction indicator
          document.querySelectorAll(".sortable-header").forEach(h => h.classList.remove('asc', 'desc'));
          header.classList.add(currentSortDirection);

          updateDisplay();
        });
      });

      // Export to JSON button
      document.getElementById("export-json-button").addEventListener("click", async () => {
        if (filteredAndSortedContainers.length === 0) {
          alert("No data to export.");
          return;
        }

        try {
          await showConfirmationModal('Export to JSON', 'Are you sure you want to download the currently displayed container data as a JSON file?', 'Download');
          const jsonContent = JSON.stringify(filteredAndSortedContainers, null, 2);
          const blob = new Blob([jsonContent], { type: "application/json" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "dockpeek_containers.json";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch {
          console.log('Export cancelled by user.');
        }
      });
    });
  </script>
</body>

</html>